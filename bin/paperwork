#!/usr/bin/env node

const PrettyError = require('pretty-error');
const chalk = require('chalk');
const command = require('../foundation/console').default;

process.stdout.write(chalk.green('-'.repeat(120)));
process.stdout.write('\x1B[2J\n\x1B[0f\u001b[0;0H');
// eslint-disable-next-line no-console
process.on('unhandledRejection', error => console.error(error));

const run = (module, options) => {
  const pretty = new PrettyError();
  const task = typeof module.default === 'undefined' ? module : module.default;

  pretty.start();
  const promise = task(options);

  if (promise && promise.catch) {
    // eslint-disable-next-line no-console
    promise.catch(exception => console.error(exception));
  }
};

// eslint-disable-next-line no-underscore-dangle
delete require.cache[__filename];
let name = process.argv[2];

if ( ! name || name.startsWith('--')) {
  name = 'start';
}

switch (name.toLowerCase()) {
  case 'start':
    process.env.NODE_ENV = 'development';
    run(command.start);

    break;
  default:
    if (name in command) {
      run(command[name]);
    } else {
      throw new Error();
    }
}
